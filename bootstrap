#!/usr/bin/env bash
set -Eeuo pipefail

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)

# ----- Safe XDG defaults (before mkdir) -----
: "${XDG_CONFIG_HOME:=$HOME/.config}"
: "${XDG_DATA_HOME:=$HOME/.local/share}"
: "${XDG_STATE_HOME:=$HOME/.local/state}"
: "${XDG_CACHE_HOME:=$HOME/.cache}"
: "${XDG_BIN_HOME:=$HOME/.local/bin}"
: "${GNUPGHOME:=$HOME/.gnupg}"

# Ensure XDG dirs exist
mkdir -p "$XDG_CONFIG_HOME" \
         "$XDG_DATA_HOME" \
         "$XDG_STATE_HOME/zsh" \
         "$XDG_CACHE_HOME/zsh" \
         "$XDG_BIN_HOME" \
         "$GNUPGHOME"
chmod 700 "$GNUPGHOME"

echo Hold on to your bootstraps !

(
  cd "${SCRIPT_DIR}"

  "${SCRIPT_DIR}"/.local/bin/stow.sh \
    -i "^\.git" \
    -i "^\.github" \
    -i "^\.pre-commit-config.yaml" \
    -i "^\.secrets.baseline" \
    -i "$(basename "${0}")" \
    -f
)

. "${HOME}"/.zshenv


if ! type mise &>/dev/null; then
  \curl https://mise.run | sh
else
  mise self-update --silent --yes
fi

mise trust "${SCRIPT_DIR}/.config/mise/config.toml"
mise plugin install neovim -q

mise install --yes
mise upgrade --bump --quiet --yes

# vim: set ft=sh ts=2 sw=2:

